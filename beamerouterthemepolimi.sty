\mode<presentation>

\newlength{\xshift}
\setlength{\xshift}{0.05\paperwidth}

% Header.
\defbeamertemplate*{frametitle}{polimi}
{
    \begin{tikzpicture}[overlay, remember picture]
    \node at ([shift={(\xshift, -0.35)}] current page.north west) [anchor=north west, inner sep=0pt]
    {
        {\small \insertsection \ifx\insertsubsection\empty\else\ - \insertsubsection\fi\leavevmode}
    };
    \node at ([shift={(\xshift, -0.85)}] current page.north west) [anchor=north west, inner sep=0pt]
    {
        \insertframetitle
    };
    \end{tikzpicture}
    \vspace{1.1cm}
}

% Use frametitle template even if \frametitle is empty.
\patchcmd{\endbeamer@frameslide}{\ifx\beamer@frametitle\@empty}{\iffalse}{}{\errmessage{Failed to patch frametitle.}}

\defbeamertemplate{headline}{page number}
{
    \ifnum\c@framenumber>1
        \vspace{\baselineskip}
        \setbeamertemplate{footline}[page number]
        \usebeamertemplate{footline}
    \fi
}

% Footer.
\defbeamertemplate{footline}{polimi}{
    \begin{minipage}[b][1cm][c]{\paperwidth}
        \ifnum\c@framenumber>1
            \hspace{\xshift}
            {\small\color{white}\insertauthor}
            \hspace*{\fill}
            \includegraphics[height=\baselineskip]{logo_bandiera.png}
            \hspace{1.5mm}
        \fi
    \end{minipage}
}

\setbeamertemplate{footline}[polimi]

% Enable nonumber option.
\BeforeBeginEnvironment{frame}{
    \setbeamertemplate{headline}[page number]
}

\makeatletter
\define@key{beamerframe}{nonumber}[true]{
    \setbeamertemplate{headline}{}
    \addtocounter{page}{-1}
}
\makeatother
